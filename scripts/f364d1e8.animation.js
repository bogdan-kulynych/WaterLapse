!function(a){"use strict";a(function(){var b="//dl.dropboxusercontent.com/u/195619889/WaterLapse/data/precipitation.json",c="//dl.dropboxusercontent.com/u/195619889/WaterLapse/data/precipitation-dates.json",d=["#EDECEA","#C8E1E7","#ADD8EA","#7FB8D4","#4EA3C8","#2586AB"],e=200,f=3,g=.5,h={scale:[],timelineWidth:0,currentFrame:0,framesCount:0,datesCount:0,years:0,playing:!1,width:window.innerWidth,height:g*window.innerWidth,ctx:null,fadeTimeout:null,frameTimeout:null,data:null},i=function(a,b){var c=(b+180)*(h.width/360),d=(-1*a+90)*(h.height/180);return[c,d]},j=function(a,b){return i(a,b)},k=function(a,b){for(var c=1/0,d=-1/0,e=0;e<a.length;++e){var f=a[e];for(e in f){var g=f[e].value;g>d&&(d=g),c>g&&(c=g)}}for(var h=d-c,i=h/(b.length-1),j=[[c,b[0]]],e=1;e<b.length;e++)j.push([c+e*i,b[e]]);return j},l=function(a,b){for(var c,d=0;d<b.length;d++)if(c=b[d][0],c>=a)return b[d][1]},m=function(a,b,c,d){a.clearRect(0,0,h.width,h.height);for(var e=0;e<b.length;++e){var f=b[e],g=j(f.lat,f.lon),i=Math.round(g[0]),k=Math.round(g[1]),m=j(f.lat+c,f.lon+c),n=Math.round(m[0]),o=Math.round(m[1]),p=l(f.value,d);a.beginPath(),a.moveTo(i,k),a.lineTo(n,k),a.lineTo(n,o),a.lineTo(i,o),a.lineTo(i,k),a.fillStyle=p,a.fill()}},n=function(b,c){var d=a("#pointer");if(b<=h.timelineWidth&&(d.css({left:b+"px"}),!c)){var e=Math.round(b/h.timelineWidth*(h.framesCount-1));p(e)}var f=a(".hover");f.is(":visible")?f.css({left:b+"px",top:a("#pointer").offset.top-30+"px"}):f.fadeIn("slow")},o=function(b){var c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],d=c[b%12]+" "+h.years[Math.floor(b/12)];a(".hover").html(d)},p=function(a){h.currentFrame=a,h.currentFrame<h.framesCount&&m(h.ctx,h.data[a],2.5,h.scale),o(a)},q=function(b){h.currentFrame<h.framesCount?(h.currentFrame++,n(h.currentFrame/h.framesCount*h.timelineWidth,!0),p(h.currentFrame)):(h.playing=!1,a(".animation-controls .play").show(),a(".animation-controls .stop").hide()),b&&(clearTimeout(h.frameTimeout),h.frameTimeout=setTimeout(function(){q(!0)},e))},r=function(){h.playing=!0,h.frameTimeout=setTimeout(function(){q(!0)},e)},s=function(){clearTimeout(h.frameTimeout)};a.getJSON(b,function(b){h.data=b,h.framesCount=Object.keys(b).length,a.getJSON(c,function(b){h.years=b;for(var c=0;c<b.length;++c)if(0===parseInt(b[c],10)%f){h.datesCount++;var d=a("<li></li>").html(b[c]);a("#slider .timeline").append(d)}h.timelineWidth=a("#slider .timeline").width(),o(0)}),a("#slider").fadeIn("slow"),a(".animation-controls .play").fadeIn("slow");var e=a("<span></span>").attr("id","pointer");a("#slider").append(e),a("#slider .timeline").click(function(b){h.playing=!1,a(".animation-controls .play").show(),a(".animation-controls .stop").hide(),clearTimeout(h.frameTimeout),n(b.pageX)}),a("body").bind("mousemove click",function(){var b=a(".animation-controls");b.fadeIn("fast"),clearTimeout(h.fadeTimeout),h.fadeTimeout=setTimeout(function(){b.fadeOut("slow")},750)}),a(".animation-controls .play").click(function(){r(),a(".animation-controls .play").hide(),a(".animation-controls .stop").show()}),a(".animation-controls .stop").click(function(){s(),a(".animation-controls .play").show(),a(".animation-controls .stop").hide()});var g=a("<canvas></canvas>").addClass("map").attr("width",h.width).attr("height",h.height);a("body").prepend(g),h.ctx=g[0].getContext("2d"),h.scale=k(b,d),a("body").addClass("loaded"),p(0)})})}(jQuery);